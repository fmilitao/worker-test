<html>
  <head>
    <title>Testing mqtt.js</title>
    <script type="text/javascript" src="paho-mqtt.js"></script>
  </head>
  <body>
    <script>
      function print(message) {
        document.body.innerHTML += message + "<br/>";
      }

      // const uri = "ws://broker.mqttdashboard.com:8000/mqtt";
      const uri = "wss://test.mosquitto.org:8081/mqtt";

      const id = Math.round(Math.random() * 10e10).toString(16);
      const clientId = `clientId-${id}`;

      print("v5");
      print(`${uri} - ${clientId}`);

      let f = () => {};
      Notification.requestPermission().then(permission => {
        document.body.innerHTML += permission.toString() + "<br/>";

        if (permission === "granted") {
          f = body =>
            new Notification("MQTT Message", {
              body
            });
        }
        // console.log("starting worker");
        // const worker = new Worker("worker2.js");
        // console.log("done");
        // worker.addEventListener("message", event => {
        //   document.body.innerHTML += event.data.toString() + "<br/>";
      });

      const client = new Paho.Client(uri, clientId);
      console.log(client);

      // set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      // connect the client
      client.connect({ onSuccess: onConnect });

      // called when the client connects
      function onConnect() {
        // Once a connection has been made, make a subscription and send a message.
        print("onConnect");
        client.subscribe("World");
        message = new Paho.Message("Hello");
        message.destinationName = "World";
        client.send(message);
      }

      // called when the client loses its connection
      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          print("onConnectionLost:" + responseObject.errorMessage);
        }
      }

      // called when a message arrives
      function onMessageArrived(message) {
        print("onMessageArrived:" + message.payloadString);
        f(message.payloadString);
      }
      //   }
      // });
    </script>
  </body>
</html>
